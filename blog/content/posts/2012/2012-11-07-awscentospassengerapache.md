+++
date = "2012-11-07T10:07:00+00:00"
draft = false
tags = ["CentOS", "rails", "passenger", "Apache"]
title = "[AWS][CentOS]passengerとapache入れる"
+++
<p><strong>apache2.4.3をコンパイルしていれる為に必要な物</strong><strong>apr, apr-util, openssl, pcrc-devel入れる</strong></p>&#13;
<pre>$ wget http://ftp.yz.yamagata-u.ac.jp/pub/network/apache//apr/apr-1.4.6.tar.gz -P /usr/local/src&#13;
$ sudo tar xvzf ./apr-1.4.6.tar.gz&#13;
$ cd ./apr-1.4.6&#13;
$./configure&#13;
$ make install&#13;
$ sudo wget http://ftp.jaist.ac.jp/pub/apache//apr/apr-util-1.5.1.tar.gz -P /usr/local/src&#13;
$ sudo tar xvzf ./apr-util-1.5.1.tar.gz&#13;
$ cd ./apr-util-1.5.1&#13;
$ ./configure --with-apr=/usr/local/apr&#13;
$ make&#13;
$ sudo make install&#13;
$ sudo yum install pcre-devel&#13;
$ sudo yum -y install openssl&#13;
</pre>&#13;
<p>参考 http://apr.apache.org/</p>&#13;
<p><strong><br />apache2.4.3をコンパイルしていれる</strong></p>&#13;
<pre>$ cd /usr/local/src&#13;
$ wget http://ftp.kddilabs.jp/infosystems/apache//httpd/httpd-2.4.3.tar.gz -P /usr/local/src&#13;
$ sudo tar xvzf ./httpd-2.4.3.tar.gz&#13;
$ ./configure --enable-mods-shraed=all --enable-ssl=shared --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr&#13;
$ make&#13;
$ sudo install&#13;
$ /usr/local/apache2/bin/httpd -v&#13;
Server version: Apache/2.4.3 (Unix)&#13;
Server built:   Nov  6 2012 22:15:34&#13;
$ &#13;
$ sudo /usr/local/apache2/bin/apachectl start&#13;
$ ps aux | grep httpd&#13;
$ netstat -an | egrep "^tcp.*:80.*LISTEN"&#13;
  tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN&#13;
</pre>&#13;
<p>ブラウザからIP叩いて「It works!」とでたら大丈夫</p>&#13;
<p>参考<br /><a href="http://httpd.apache.org/docs/2.4/install.html">http://httpd.apache.org/docs/2.4/install.html</a> </p>&#13;
<p>aprやapr-utilは同じhttpdのsourceにインクルードしてるよんって書いてある気がするけどapr, apr-util入れないと上手く行かなかった。だろうか・・・<br /><a href="http://httpd.apache.org/docs/2.4/programs/configure.html">http://httpd.apache.org/docs/2.4/programs/configure.html</a> </p>&#13;
<p><br /><strong>apacheのパス通す</strong></p>&#13;
<pre>$ vim ~/.bashrc&#13;
+ PATH=$PATH:/usr/local/apache2/bin&#13;
$ source ~/.bashrc&#13;
</pre>&#13;
<p><br /><strong>passnger gem入れる</strong></p>&#13;
<pre>$ gem install passenger&#13;
$ passenger-install-apache2-module&#13;
Welcome to the Phusion Passenger Apache 2 module installer, v3.0.18.&#13;
</pre>&#13;
<p><strong><br />httpd.confの編集</strong></p>&#13;
<pre>$ sudo vim /etc/httpd/conf/httpd.conf&#13;
</pre>&#13;
<p><br />モジュール一覧</p>&#13;
<p>・virtual host使うためにvhost_alias_module ・sslモジュール使うためにmod_slotmem_shm と mod_socache_shmcb必要</p>&#13;
<pre>LoadModule authn_file_module modules/mod_authn_file.so&#13;
LoadModule authn_core_module modules/mod_authn_core.so&#13;
LoadModule authz_host_module modules/mod_authz_host.so&#13;
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so&#13;
LoadModule authz_user_module modules/mod_authz_user.so&#13;
LoadModule authz_core_module modules/mod_authz_core.so&#13;
LoadModule access_compat_module modules/mod_access_compat.so&#13;
LoadModule auth_basic_module modules/mod_auth_basic.so&#13;
LoadModule reqtimeout_module modules/mod_reqtimeout.so&#13;
LoadModule filter_module modules/mod_filter.so&#13;
LoadModule mime_module modules/mod_mime.so&#13;
LoadModule log_config_module modules/mod_log_config.so&#13;
LoadModule env_module modules/mod_env.so&#13;
LoadModule headers_module modules/mod_headers.so&#13;
LoadModule setenvif_module modules/mod_setenvif.so&#13;
LoadModule version_module modules/mod_version.so&#13;
LoadModule slotmem_shm_module modules/mod_slotmem_shm.so&#13;
LoadModule ssl_module modules/mod_ssl.so&#13;
LoadModule unixd_module modules/mod_unixd.so&#13;
LoadModule status_module modules/mod_status.so&#13;
LoadModule autoindex_module modules/mod_autoindex.so&#13;
LoadModule vhost_alias_module modules/mod_vhost_alias.so&#13;
LoadModule dir_module modules/mod_dir.so&#13;
LoadModule alias_module modules/mod_alias.so&#13;
</pre>&#13;
<p><br />Railsのエラードキュメントが表示されるよう変更</p>&#13;
<pre>ErrorDocument 500 /500.html&#13;
ErrorDocument 404 /404.html&#13;
ErrorDocument 422 /422.html&#13;
</pre>&#13;
<p><br />起動権限の譲渡</p>&#13;
<pre>#&#13;
# If you wish httpd to run as a different user or group, you must run&#13;
# httpd as root initially and it will switch.&#13;
#&#13;
# User/Group: The name (or #number) of the user/group to run httpd as.&#13;
# It is usually good practice to create a dedicated user and group for&#13;
# running httpd, as with most system services.&#13;
#&#13;
User webadmin&#13;
Group webadmin&#13;
</pre>&#13;
<p><br />何か会った時のメール連絡先を設定</p>&#13;
<pre>ServerAdmin foo@hoge.com&#13;
</pre>&#13;
<p><br />Railsのエラードキュメントが表示されるよう変更</p>&#13;
<pre>ErrorDocument 500 /500.html&#13;
ErrorDocument 404 /404.html&#13;
ErrorDocument 422 /422.html&#13;
</pre>&#13;
<p><br />global以外の&lt;Directory /usr/local/apache2/htdocs&gt;を削除</p>&#13;
<p><br />virtual hostの設定を追加</p>&#13;
<pre>&lt;VirtualHost *:80&gt;&#13;
  ServerName hoge.com:80&#13;
  SetEnv DATABASE_CONFIG production&#13;
  DocumentRoot /var/www/app/hoge/public&#13;
  PassengerAppRoot /var/www/app/hoge/&#13;
&lt;/VirtualHost&gt;&#13;
</pre>&#13;
<p><br />/var/www/app配下のDirectoryセッティングしちゃう</p>&#13;
<pre>&lt;Directory "/var/www/app"&gt;&#13;
  AllowOverride None&#13;
  Options FollowSymLinks&#13;
  Require all granted<br />&lt;/Directory&gt;</pre>&#13;
<p><br />httpd-passenger.confの追加</p>&#13;
<pre>$ cd /usr/local/apache2/conf/extra&#13;
$ sudo vim ./httpd-passenger.conf&#13;
&#13;
# passenger setting&#13;
LoadModule passenger_module /home/webadmin/.rvm/gems/ruby-1.9.3-p286@hoge/gems/passenger-3.0.18/ext/apache2/mod_passenger.so&#13;
PassengerRoot /home/webadmin/.rvm/gems/ruby-1.9.3-p286@hoge/gems/passenger-3.0.18&#13;
PassengerRuby /home/webadmin/.rvm/wrappers/ruby-1.9.3-p286@hoge/ruby&#13;
&#13;
# passenger option setting&#13;
PassengerLogLevel 0 # error and warning only&#13;
PassengerHighPerformance on&#13;
&#13;
# rails setting&#13;
RackEnv production&#13;
RailsEnv production&#13;
RailsBaseURI /&#13;
&#13;
SetEnv MY_RUBY_HOME "/var/www/.rvm/rubies/ruby-1.9.3-p194"&#13;
SetEnv GEM_HOME "/home/webadmin/.rvm/gems/ruby-1.9.3-p286@hoge"&#13;
SetEnv GEM_PATH "/home/webadmin/.rvm/gems/ruby-1.9.3-p286@hoge"&#13;
&#13;
</pre>&#13;
<p>passengerのconfig optionについては、以下を参照</p>&#13;
<p><a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod">http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod</a></p>&#13;
<p><br /><br />間違いやイケテナイところなどありましたらご指摘願います。<br /> </p> 